<!DOCTYPE html>
<html lang="en">
<head>
  <title>Calidad del Aire</title>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

  <link rel="shortcut icon" href="https://framework-gb.cdn.gob.mx/favicon.ico">
  <link href="https://framework-gb.cdn.gob.mx/assets/styles/main.css" rel="stylesheet">

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <link href="css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css"
  integrity="sha512-wcw6ts8Anuw10Mzh9Ytw4pylW8+NAD4ch3lqm9lzAsTxg0GFeJgoAtxuCLREZSC5lUXdVyo/7yfsqFjQ4S+aKw=="
  crossorigin=""/>
  <!-- Fuente Roboto-->
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,700" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Tangerine">

  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <!-- Latest compiled and minified JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>

<body class="page" cz-shortcut-listen="true" >
  <main>

    <div class="forLoader" id="forLoader1">
    	 <div class="loader"></div>
     </div>


    <div id="videoBlock" class="cabezera">
      <video preload="preload"  id="video" autoplay="autoplay" loop="loop" playsinline muted>

      <source src="imagenes/nubes.mp4" type="video/mp4">
      </video>
      <div class="section no-pad-bot">
        <div class="container" style="margin-top:-600px;">
          <div class="row">
            <div class="col-xs-12 text-center">
              <h2>Calidad de Aire MX</h2>
              <p><strong><i>Selecciona tu estado y estación para obtener información</i></strong></p>
            </div>
          </div>

          <div class="row">
            <div class="col-xs-12 text-center margen_arriba_g">

             <div class="base_botones">
                <select class="browser-default contaminantes" name="" onchange="ponEstacionesSel()" id="estado_primer_select"></select>

                <select class="browser-default contaminantes" name="" onchange="ponContaminantesSel()" id="estaciones_select">
                    <option value="0">2.-Selecciona una estación</option>
                </select>

                <select class="browser-default contaminantes" name="" id="contaminantes" style="display: none;">
                  <option value="0">3.-Selecciona un contaminate</option>
                </select>
              </div>

            </div>
            <div class="col-xs-12 text-center">
              <h5 class="white-text"><span id="contaminante_titulo"><a style="color: white" href="preguntas.html">Preguntas frecuentes </a>|<a style="color: white" href="glosario.html"> Glosario</a> </span></h5>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container hidden-xs">
      <div class="row mapa_titulo">
        <div class="col-xs-12">
          <h2>Estaciones de medición de contaminantes</h2>
          <hr class="red">
        </div>
        <div class="col-xs-3">
          <div class="input-field col s6 m2 l2">
            <select  name="estados" class="form-control" onchange="cambiaCoor()">
              <option value="Aguascalientes">Aguascalientes</option>
              <option value="Baja California">Baja California</option>
              <option value="Baja California Sur">Baja California Sur</option>
              <option value="Campeche">Campeche</option>
              <option value="Chiapas">Chiapas</option>
              <option value="Chihuahua">Chihuahua</option>
              <option value="Ciudad de México">Ciudad de México</option>
              <option value="Coahuila de Zaragoza">Coahuila de Zaragoza</option>
              <option value="Colima">Colima</option>
              <option value="Durango">Durango</option>
              <option value="Guanajuato">Guanajuato</option>
              <option value="Guerrero">Guerrero</option>
              <option value="Hidalgo">Hidalgo</option>
              <option value="Jalisco">Jalisco</option>
              <option value="México">México</option>
              <option value="Michoacán de Ocampo">Michoacán de Ocampo</option>
              <option value="Morelos">Morelos</option>
              <option value="Nayarit">Nayarit</option>
              <option value="Nuevo León">Nuevo León</option>
              <option value="Oaxaca">Oaxaca</option>
              <option value="Puebla">Puebla</option>
              <option value="Querétaro de Arteaga">Querétaro de Arteaga</option>
              <option value="Quintana Roo">Quintana Roo</option>
              <option value="San Luis Potosí">San Luis Potosí</option>
              <option value="Sinaloa">Sinaloa</option>
              <option value="Sonora">Sonora</option>
              <option value="Tabasco">Tabasco</option>
              <option value="Tamaulipas">Tamaulipas</option>
              <option value="Tlaxcala">Tlaxcala</option>
              <option value="Veracruz de Ignacio de la Llave">Veracruz de Ignacio de la Llave</option>
              <option value="Yucatán">Yucatán</option>
              <option value="Zacatecas">Zacatecas</option>
            </select>
          </div>
        </div>
      </div>
    </div>

	<div class="container">
	    <div class="row">
	      <div class="col col-xs-12 hidden-xs">
	        <div id="mapid"></div>
	      </div>
      </div>
	</div>

	<div class="container hidden-xs">
	    <div class="row">
	      <div class="col col-xs-12">
          <h3>Datos</h3>
          <hr class="red">
	        <div class="data-table" style="color: black; margin-bottom: 50px;">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>Institución</th>
                    <th>Formato</th>
                  </tr>
                </thead>
                <tbody>
                  <tr id="dato" data-href="https://datos.gob.mx/busca/dataset/proveedores-comercializacion-y-cultivos">
                    <td id="nombreDato" class="">Calidad de aire</td>
                    <td id="institucionDato" width="25%" class="">INECC</td>
                    <td width="10%">
                      <span id="tipoDato" data-format="XLS" class="dataset-format">JSON</span>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
	      </div>
	    </div>
	</div>

    <!-- Modal -->
    <div class="modal fade" id="alertModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Mensaje</h4>
          </div>
          <div class="modal-body">
            El parámetro seleccionado no cuenta con lecturas
          </div>
          <div class="modal-footer">
            <button type="button" class="btn" data-dismiss="modal" style="color:#fff; background-color: #87c8f3;"> Aceptar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <p class="titulo"><strong id="titulo_detalle">Ciudad Fernández</strong></p>
          </div>
          <div class="modal-body">
            <!-- esto sera el modal -->

              <div class="row ">
                <div class="col-xs-3 hidden-xs">
                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/fecha.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Fecha</b></p>
                    <p id="fecha_detalle">24/05/17</p>
                  </div>

                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/estacion.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b>Estación:</b></p>
                    <p id="estacion_detalle">XAL-Xalostoc</p>
                  </div>

                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/temperatura.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Temperatura</b></p>
                    <p id="temperatura_detalle">No disponible</p>
                  </div>

                  <div class="col-xs-4">
                    <img class="img-responsive" src="imagenes/contaminante.png">
                  </div>
                  <div class="col-xs-8">
                    <p><b >Contaminante:</b></p>
                    <p id="contaminante_detalle">PM10, 104</p>
                  </div>

                </div>
                <div class="col-xs-9 hidden-xs">
                    <div class="col-xs-12">
                        <p class="titulo"><strong>Valores maximos registrados del contaminate <span id="contaminante_grafica"> XXX </span></strong></p>
                    </div>
                    <div class="row margenes_pop">
                      <div class="row">
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Las partículas menores o iguales a 10 micras (PM10) se depositan en la región extratorácica del tracto respiratorio (nariz, boca, naso, oro y laringofarínge); contienen principalmente materiales de la corteza terrestre y se originan en su mayoría por procesos de desintegración de partículas más grandes. También pueden contener material biológico como
polen, esporas, virus o bacterias o provenir de la combustión incompleta de combustibles fósiles." class="active_pop boton_pop" id="botonPM10" onclick="cambioParametro('PM10',24,'botonPM10','Las partículas menores o iguales a 10 micras (PM10) se depositan en la región extratorácica del tracto respiratorio (nariz, boca, naso, oro y laringofarínge); contienen principalmente materiales de la corteza terrestre y se originan en su mayoría por procesos de desintegración de partículas más grandes. También pueden contener material biológico como polen, esporas, virus o bacterias o provenir de la combustión incompleta de combustibles fósiles.','PM10 (µg/m&sup3;)')">PM10 (µg/m&sup3;) 24 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Las partículas menores o iguales a 2.5 micras (PM2.5) están formadas primordialmente por gases y por material proveniente de la combustión. Se depositan fundamentalmente en la región traqueobronquial (tráquea hasta bronquiolo terminal), aunque pueden ingresar a los alvéolos." class="boton_pop" id="botonPM25" onclick="cambioParametro('PM2.5',24,'botonPM25','Las partículas menores o iguales a 2.5 micras (PM2.5) están formadas primordialmente por gases y por material proveniente de la combustión. Se depositan fundamentalmente en la región traqueobronquial (tráquea hasta bronquiolo terminal), aunque pueden ingresar a los alvéolos.', 'PM2.5 (µg/m&sup3;)')">PM2.5 (µg/m&sup3;) 24 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="El dióxido de nitrógeno es un compuesto químico gaseoso de color marrón amarillento, es un gas tóxico e irritante. La exposición a este gas disminuye la capacidad de difusión pulmonar." class="boton_pop" id="botonNO2" onclick="cambioParametro('NO2','D','botonNO2','El dióxido de nitrógeno es un compuesto químico gaseoso de color marrón amarillento, es un gas tóxico e irritante. La exposición a este gas disminuye la capacidad de difusión pulmonar.','NO2 (ppm)')">NO2 (ppm) Dato horario</p>
                        </div>
                      </div>
                      <div class="row">
                        <div class=" col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios." class="boton_pop" id="botonSO2D" onclick="cambioParametro('SO2','D','botonSO2D','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)')">SO2 (ppm) Dato horario</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios." class="boton_pop" id="botonSO28" onclick="cambioParametro('SO2',8,'botonSO28','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)')">SO2 (ppm) 8 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios." class="boton_pop" id="botonSO224" onclick="cambioParametro('SO2',24,'botonSO224','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)')">SO2 (ppm) 24 horas</p>
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias." class="boton_pop" id="botonO3D" onclick="cambioParametro('O3','D','botonO3D','Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.','O3 (ppm)')">O3 (ppm) Dato horario</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias." class="boton_pop" id="botonO38" onclick="cambioParametro('O3',8,'botonO38','Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.','O3 (ppm)')">O3 (ppm) 8 horas</p>
                        </div>
                        <div class="col-xs-4">
                          <p data-toggle="tooltip" data-placement="bottom" title="Es un gas incoloro e inodoro que en concentraciones altas puede ser letal ya que forma carboxihemoglobina, la cual impide la oxígenación de la sangre." class="boton_pop" id="botonCO" onclick="cambioParametro('CO',8,'botonCO','Es un gas incoloro e inodoro que en concentraciones altas puede ser letal ya que forma carboxihemoglobina, la cual impide la oxígenación de la sangre.','CO (ppm)')">CO (ppm) 8 horas</p>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="col-xs-12 hidden-sm hidden-md hidden-lg text-center">
                  <select name="conataminatesMovil" id="conataminatesMovil">
                    <option value="PM10">PM10 (µg/m&sup3;) 24 horas</option>
                    <option value="PM2.5">PM2.5 (µg/m&sup3;) 24 horas</option>
                    <option value="NO2">NO2 (ppm) Dato horario</option>
                    <option value="SO2D">SO2 (ppm) Dato horario</option>
                    <option value="SO28">SO2 (ppm) 8 horas</option>
                    <option value="SO224">SO2 (ppm) 24 horas</option>
                    <option value="O3D">O3 (ppm) Dato horario</option>
                    <option value="O38">O3 (ppm) 8 horas</option>
                    <option value="CO8">CO (ppm) 8 horas</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="col-xs-12 col-sm-3 text-center">
                    <div class="chart-gauge"></div>

                </div>
                <div class="col-xs-12 col-sm-9">
                  <div class="col-xs-12">
                    <h5 id="tituloTexto">parametro</h5>
                    <p id="textoTitulo">Lorem ipsum dolor sit, amet consectetur adipisicing elit. Molestias, delectus voluptate error libero, repudiandae </p>
                    <p>[ESPACIO PARA RECOMENDACIONES]</p>
                  </div>
                </div>
              </div>
              <div class="row hidden-xs">
                <div class="col-xs-12 offset-m1 offset-l2">
                  <canvas id="myChart"></canvas>
                </div>
                <div class="col-xs-12 botonera">
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" class="parametro">boton 1</a>
                  <a href="#" id="pinta_primero" class="parametro active">boton 1</a>
                </div>
                <input type="hidden" name="estacion" id="estacion_id" value="">
                <input type="hidden" name="ciudad" id="ciudad" value="">
              </div>

          </div> <!-- fin del body  -->
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
          </div>

      </div>
    </div>
    </div>

  </main>

    <script src="https://framework-gb.cdn.gob.mx/gobmx.js"></script>

    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
    <!-- Leaflet-->
    <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"
    integrity="sha512-mNqn2Wg7tSToJhvHcqfzLMU6J4mkOImSPTxVZAdo+lcPlk+GhZmYgACEe0x35K7YzW1zJ7XyJV/TT1MrdXvMcA=="
    crossorigin=""></script>

    <script src="libs/chartjs/Chart.bundle.js"></script>
    <script src="libs/chartjs/utils.js"></script>
    <script src="js/jquery.gaugeIt.js"></script>

    <!-- local-->
    <script src="js/utileria.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/estados_mexico.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/estaciones_json.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/mod_mapa.js" type="text/javascript" charset="utf-8"></script>
    <script>
      var dataLocal = [];
      var chart;
      var ctx;
      var color;
      var mymap = L.map('mapid').setView([16.8889,-100], 5);

      var valores = [];
      var valoresRango = [];
      var etiquetas = [];

      var ant_val_arr = [];
      var ant_lab_arr = [];

      var d = new Date();
      var anio = d.getFullYear();
      var mes = meis[d.getMonth()];
      var dia = deis[d.getDate()];

      //catalogo de constantes de configuración
      const pageSize_estaciones = 2000;
      var arrPM2 = arrPM2 = arrNO2 = arrCO = arrO3 = arrSO2 = [];

      //emulacion de states
      var pm10Vacio = false;
      var indicadorMostrado = false;


      $(document).ready(function()
      {
        $('[data-toggle="tooltip"]').tooltip();

	      // Oculta Loader
	     $('.forLoader').removeClass('hide').slideUp();

        /* instancia del mapa*/
          mymap.panTo(new L.LatLng(24.8, -100));

          var OpenStreetMap_BlackAndWhite = L.tileLayer('http://{s}.tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png',
          {
            maxZoom: 18,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
          });

          OpenStreetMap_BlackAndWhite.addTo(mymap);
          if( /Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)) mymap.dragging.disable();
          mymap.scrollWheelZoom.disable();
        /*fin de instancia del mapa*/


        $('#estado_primer_select').html(options_estado());
        //$('#estaciones_select').html(options_estaciones());
        $('#contaminantes').change(function()
        {
          $('.forLoader').show();
          //conseguimos todas las variables necesarias para hacer la llamada a el API
          var estado =  $('#estado_primer_select').val();
          var estacion =  $('#estaciones_select').val();

          var b = $('#contaminantes').val();
          var a = b.split('_');
          var parametro = a[0];
          var horas = a[1];

          horas = 24;
          parametro = 'PM10';

          //porEstaciones(estado, estacion, parametro, horas); //llamada a la estación

          //ponemos los parametros en la ventana
          $('#fecha_detalle').html(convertDate(new Date()));
          $('#contaminante_detalle').html(parametro);
          $('#contaminante_grafica').html(parametro);
          $('#titulo_detalle').html(buscarCiudad(estacion));
          $('#estacion_detalle').html($('#estaciones_select option:selected').text());


          var id;
          switch (b) {
            case 'PM10_24':   id='botonPM10'; break;
            case 'PM2.5_24':  id='botonPM25'; break;
            case 'SO2_24':    id='botonSO224'; break;
            case 'SO2_8':     id='botonSO28'; break;
            case 'SO2_D':     id='botonSO2D'; break;
            case 'O3_8':      id='botonO38'; break;
            case 'O3_D':      id='botonO3D'; break;
            case 'NO2_24':    id='botonNO2'; break;
            case 'CO_24':     id='botonCO'; break;
            default: id=''; break;
          }

          id = 'botonPM10';
          console.log(id);


          $('#tituloTexto').html(parametro);
          $('#textoTitulo').html($('#'+id).attr('data-original-title'));

          cambioBotonActivo(id);

          //vamos a llenar los arreglos de todos los coantaminantes
          llenarConstaminantes(generaUrl('PM10', estacion, (24*28)),'PM10');
          llenarConstaminantes(generaUrl('PM2.5', estacion, (24*28)),'PM2.5');
          llenarConstaminantes(generaUrl('NO2', estacion, (24*28)),'NO2');
          llenarConstaminantes(generaUrl('SO2', estacion, (24*28)),'SO2');
          llenarConstaminantes(generaUrl('O3', estacion, (24*28)),'O3');
          llenarConstaminantes(generaUrl('CO', estacion, (24*28)),'CO');
        });

        /*instancia de la grafica*/
        ctx = document.getElementById('myChart').getContext('2d');
        color = Chart.helpers.color;
        chart = new Chart(ctx,
        {
          type: 'line',
          data:
          {
            labels: ["January", "February", "March", "April", "May", "June", "July"],
            datasets:
            [
              {
                label: "Contaminantes",
                backgroundColor: color(window.chartColors.blue).alpha(0.2).rgbString(),
                borderColor: window.chartColors.blue,
                pointBackgroundColor: window.chartColors.blue,
                data: [0, 10, 5, 2, 20, 30, 45],
              },
                {
                    label: "Valores maximos",
                    borderColor: window.chartColors.red,
                    backgroundColor: window.chartColors.red,
                    fill: false,
                    data:[10, 10, 10, 10, 10, 10, 10]
                }
            ]
          },
          options:
          {
            legend:
            {
              display: false
            },
            tooltips: {
              enabled: true
            },
            scales: {
              xAxes: [{
                ticks: {
                  autoSkip: false,
                  maxRotation: 90,
                  minRotation: 90
                }
              }]
            }
          },
        });
        // fin de instancia de la grafica

        $('.parametro').click(function()
        {
          event.preventDefault();

          $('.parametro').each(function(index){
            $( this ).removeClass('active');
          });

          $( this ).addClass('active');

          var boton = parseInt($( this ).val());
          if(ant > boton){
            var tam =  ant - boton;
            for (var i = 0; i < tam; i++) {
              ant_val_arr.push(chart.data.datasets[0].data.splice(0, 1));
              ant_lab_arr.push(chart.data.labels.splice(0, 1));
            }
          }else if(ant < boton){
            var tam = boton - ant;
            for (var i = 0; i < tam; i++) {
              chart.data.datasets[0].data.unshift(ant_val_arr.pop()[0]);
              chart.data.labels.unshift(ant_lab_arr.pop()[0]);
            }
          }

          ant = boton;
          chart.update();
        });

        //select para version movil
        $('#conataminatesMovil').change(function ()
        {
          if('PM10' == $(this).val())
          {
            cambioParametro('PM10',24,'botonPM10','Las partículas menores o iguales a 10 micras (PM10) se depositan en la región extratorácica del tracto respiratorio (nariz, boca, naso, oro y laringofarínge); contienen principalmente materiales de la corteza terrestre y se originan en su mayoría por procesos de desintegración de partículas más grandes. También pueden contener material biológico como polen, esporas, virus o bacterias o provenir de la combustión incompleta de combustibles fósiles.','PM10 (µg/m&sup3;)')
          }
          else if('PM2.5' == $(this).val())
          {
            cambioParametro('PM2.5',24,'botonPM25','Las partículas menores o iguales a 2.5 micras (PM2.5) están formadas primordialmente por gases y por material proveniente de la combustión. Se depositan fundamentalmente en la región traqueobronquial (tráquea hasta bronquiolo terminal), aunque pueden ingresar a los alvéolos.', 'PM2.5 (µg/m&sup3;)');
          }
          else if('NO2' == $(this).val())
          {
            cambioParametro('NO2','D','botonNO2','El dióxido de nitrógeno es un compuesto químico gaseoso de color marrón amarillento, es un gas tóxico e irritante. La exposición a este gas disminuye la capacidad de difusión pulmonar.','NO2 (ppm)')
          }
          else if('SO2D' == $(this).val())
          {
            cambioParametro('SO2','D','botonSO2D','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)')
          }
          else if('SO28' == $(this).val())
          {
            cambioParametro('SO2',8,'botonSO28','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)');
          }
          else if('SO224' == $(this).val())
          {
            cambioParametro('SO2',24,'botonSO224','Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.','SO2 (ppm)');
          }
          else if('O3D' == $(this).val())
          {
            cambioParametro('O3','D','botonO3D','Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.','O3 (ppm)');
          }
          else if('O38' == $(this).val())
          {
            cambioParametro('O3',8,'botonO38','Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.','O3 (ppm)');
          }
          else if('CO8' == $(this).val())
          {
            cambioParametro('CO',8,'botonCO','Es un gas incoloro e inodoro que en concentraciones altas puede ser letal ya que forma carboxihemoglobina, la cual impide la oxígenación de la sangre.','CO (ppm)');
          }
        });
      }); // fin de document ready

      function buscarCiudad(idEstacion)
      {
        var city = '';
        for (let index = 0; index < estaciones_json.length; index++) {
          const element = estaciones_json[index];
          if(element.id == idEstacion)
          {
            city =  element.city;
            break;
          }
        }
        return city;
      }

      function cambioBotonActivo(id)
      {
        //cambio de active boton
        $(".boton_pop").each(function()
        {
          $(this).removeClass( "active_pop" )
        });
        $('#'+id).addClass('active_pop');
      }

      function hacerFechaValida(fecha)
      {
        var fechaPartida = fecha.split("T");
        var tiempoPartido =  fechaPartida[1].split(".");

        console.log(fechaPartida[0]+' '+tiempoPartido[0]);

        return fechaPartida[0]+' '+tiempoPartido[0];
      }

      function convertDate(inputFormat)
      {
        function pad(s) { return (s < 10) ? '0' + s : s; }
        var d = new Date(inputFormat);
        return [pad(d.getDate()), pad(d.getMonth()+1), d.getFullYear()].join('/');
      }

      function options_estado()
      {
        var options  = '<option value="0">1.-Selecciona un estado</option>';
        for (let index = 0; index < coor_estado.length; index++)
        {
          const element = coor_estado[index];
          options += '<option value="'+element.estado+'">'+element.estado+'</option>'
        }

        return options;
      }

      function porEstaciones(estado,id_estacion,parametro,horas)
      {
        const dActual = new Date();
        var dPasada = new Date();

        // const dActual = DateFalsa();
        // var dPasada = DateFalsa();

        var isDatoHorario =  (horas == 'D') ? true : false;

        if(isDatoHorario)
        {
          horas = 2;
        }

        dPasada.setHours(dActual.getHours() - horas);

        var url = 'https://api.datos.gob.mx/v1/sinaica-30?estacionesid='+id_estacion+'&parametro='+parametro;

        // var url = 'https://api.datos.gob.mx/v1/sinaica?parametro=[text:'+parametro+']&estacionesid='+id_estacion+'&date-insert=[range:'+getFormatDateAPI(dPasada)+'%7C'+getFormatDateAPI(dActual)+']&pageSize='+50;

        console.log(url);
        $.ajax({
          type: 'GET',
          url: url,
          data: {},
          success: function( data, textStatus, jqxhr )
          {
            console.log('datos');
            console.log(data);

            if(data.results.length > 0)
            {
                var promedio = 0;
                if(isDatoHorario)//validamos si es dato horario
                {
                  console.log('Dato horario');
                  for (let index = data.pagination.total-1; index > 0; index--)
                  {
                    if(data.results[index].parametro == parametro)
                    {
                      promedio =  data.results[index].valororig;
                      break;
                    }
                  }
                }
                else
                {
                  //filtramos el parametro deseado
                  var dataParametro = [];
                  for (let index = 0; index < data.pagination.total; index++)
                  {
                    if(data.results[index].parametro == parametro)
                    {
                      dataParametro.push(data.results[index]);
                    }
                  }

                  console.log(dataParametro);
                  // validamos qiue según el parametro pueda ser promediado
                  if(dataParametro.length > 1) // cambiar para hacer el maximo modificable
                  {
                    var tam = dataParametro.length;
                    var acumulado = 0;
                    for (let index = 0; index < tam; index++)
                    {
                      acumulado  =  acumulado + dataParametro[index].valororig;
                    }
                    console.log(acumulado);
                    promedio =  acumulado / tam;
                  }

                  console.log(promedio);
                }

                if(promedio != 0)
                {
                  //temporal en lo que meto el gauge
                  // $('.chart-gauge').html('<p>'+promedio+'</p>');
                  var valor = promedio.toFixed(2);
                  var maximo = 100;
                  $('.chart-gauge').html('');
                  $('.chart-gauge').gaugeIt({selector:'.chart-gauge',value:valor,gaugeMaxValue:maximo});

                  //consideraciones
                  // tenemos datos maximos
                  // tenemos un campo llamado valoring que se debe considerar
                  //tenemos que vlaidar que se tenga 75% de datos para poder hacer el promedio si no se deja como dato vacio

                  //poner la grafica
                  //crear otra funcion que haga una llamada de 28 dias con los parametros de la llamada anterior


                  var dPasada28 = new Date();
                  dPasada.setHours(dActual.getHours() - (28*24));

                  var url28 = 'https://api.datos.gob.mx/v1/sinaica-30?estacionesid='+id_estacion+'&parametro='+parametro+'&pageSize='+pageSize_estaciones;


                  // var url28 = 'https://api.datos.gob.mx/v1/sinaica?parametro=[text:'+parametro+']&estacionesid='+id_estacion+'&date-insert=[range:'+getFormatDateAPI(dPasada)+'%7C'+getFormatDateAPI(dActual)+']&pageSize='+pageSize_estaciones;
                  console.log(url28);
                  createArrayGrafica(url28, parametro,horas,promedio);


                  //Mostramos la botonera por si fue ocualta en el apso anterior
                  $('.botonera').show();
                  $('#myModal').modal('show'); // mandar a llamar al modal
                }
                else
                {
                  desabilitarGrafica();
                }

            }
            else
            {
              desabilitarGrafica();
            }

          },
          error: function (xhr, ajaxOptions, thrownError)
          {
            alert(xhr.status);
            alert(thrownError);
          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:true
        });
      }

      function desabilitarGrafica()
      {
        $('#alertModal').modal('show');
        $('#alertModal').css({'display':'flex','align-items':'center'});
        var valor = 0;
        var maximo = 100;
        $('.chart-gauge').html('');
        $('.chart-gauge').gaugeIt({selector:'.chart-gauge',value:valor,gaugeMaxValue:maximo});

        //vaciamos la grafica para mostrar que no tenemos lectura
        for(var i=0; i< valores.length; i++)
        {
            valores[i] =  null;
            valoresRango[i] = null;
        }
        actualizar_grafica_detalle(valores, etiquetas);
        //ocultamos la botonera para que no se pueda utilizar
        $('.botonera').hide();
      }

      function createArrayGrafica(url, parametro, horas,promedio)
      {
        $.ajax({
          type: 'GET',
          url: url,
          data: {},
          success: function( data, textStatus, jqxhr )
          {
            arrPM10 = data;
            console.log('data obtenida');
            console.log(data);
            dataLocal = data;
            putGrafica(parametro, horas,promedio);
            // Oculta Loader
            $('.forLoader').removeClass('show').slideUp();
          },
          error: function (xhr, ajaxOptions, thrownError)
          {
            alert(xhr.status);
            alert(thrownError);
          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:true
        });
      }

      function putGrafica(parametro,horas,promedio2)
      {
        console.log('vamos a hacer todos los datos, tomando el dataLocal');
        console.log(dataLocal);
        var data = dataLocal;
        var maximo = 1580;
              var estacionesid = $('#estacion_id').val();
              var his_estacion =  [];
              var labels_temp = [];
              var values_temp = [];

              for (var i = 0; i < data.results.length; i++)
              {
                if(data.results[i].parametro == parametro)
                {
                  if(!Array.isArray(his_estacion[data.results[i].fecha]))
                  {
                    his_estacion[data.results[i].fecha] = [];
                    labels_temp.push(data.results[i].fecha);
                  }

                  //validacion desde el api para valores correctos
                  if(data.results[i].validoorig == 1){
                    his_estacion[data.results[i].fecha].push(data.results[i]);
                  }

                }

              }

              for (var i = 0; i < labels_temp.length; i++)
              {
                var promedio = his_estacion[labels_temp[i]].length;
                  console.log(promedio);
                var suma = 0;
                var arreglo = his_estacion[labels_temp[i]];
                for (var j = 0; j < promedio; j++) {
                  if(arreglo[j].valororig < maximo)
                    suma += arreglo[j].valororig;
                }

                if(parametro ==  'PM10' || parametro == 'PM2.5')
                  values_temp.push((suma/promedio).toFixed(1));
                else
                  values_temp.push((suma/promedio).toFixed(3));
              }

              valores = values_temp;
              //forzamos el primer valor
              valores[values_temp.length-1] = promedio2.toFixed(2);
              rangoInecc(parametro,horas);
              var labels_temp2 = [];
              for (var i = 0; i < labels_temp.length; i++)
              {
                labels_temp2[i] = get_fecha_formato(labels_temp[i]);
              }
              etiquetas =  labels_temp2;
              console.log(labels_temp2);

              actualizar_grafica_detalle(valores, etiquetas);
      }

      function rangoInecc(parametro, horas)
      {
          var rango = 0;
          var cadena = parametro+''+horas;
          console.log(cadena);
          switch(cadena)
          {
              case "PM1024":
                  rango = 75;
              break;
              case "PM2.524":
                  rango = 45;
              break;
              case "O3D":
                  rango = 0.095;
              break;
              case "SO2D":
                  rango = 0.025;
              break;
              case "SO224":
                  rango = 0.11;
              break;
              case "SO28":
                  rango = 0.2;
              break;
              case "O38":
                  rango = 0.07;
              break;
              case "NO2D":
                  rango = 0.21;
              break;
              case "CO8":
                  rango = 11;
              break;
              default:
                  rango = 0;
          }

          for(var i = 0; i< valores.length; i++)
          {
            valoresRango[i] = rango;
          }
      }

      function actualizar_grafica_detalle(valores,etiquetas)
      {
        chart.data.datasets[0].data =  valores;
        chart.data.datasets[1].data =  valoresRango;
        chart.data.labels =  etiquetas;
        chart.update();
        poner_botones(valores);
      }

      function poner_botones(valores)
      {
        ant = valores.length;
        var parametro =  valores.length/4
        console.log(parametro);

        $('.parametro').each(function(index){
          $( this ).text(Math.round(parametro*(index+1))+' días');
          $( this ).val(Math.round(parametro*(index+1)));
          console.log($( this ).val());
        });
      }

      function convertDate(date)
      {
        var yyyy = date.getFullYear().toString();
        var mm = (date.getMonth()+1).toString();
        var dd  = date.getDate().toString();

        var mmChars = mm.split('');
        var ddChars = dd.split('');

        return yyyy + '-' + (mmChars[1]?mm:"0"+mmChars[0]) + '-' + (ddChars[1]?dd:"0"+ddChars[0]);
      }

      function sumarDias(fecha, dias)
      {
        fecha.setDate(fecha.getDate() + dias);
        return fecha;
      }

      function getFormatDateAPI(d)
      {
        var fecha = d.getFullYear()+'-'+ meis[d.getMonth()] +'-'+((d.getDate() < 10?'0':'') + d.getDate())      +'T'+ ( (d.getHours() < 10?'0':'') + d.getHours() ) +':'+( (d.getMinutes()<10?'0':'') + d.getMinutes() )+':00';
        return fecha;
      }

      function ponEstacionesSel()
      {
        console.log('cambio de contenido para las estaciones');

        var x = document.getElementById("estado_primer_select").value;
        var contenido = '<option value="0">2.-Seleccionar estación</option>';
        var numEstaciones = 0;
        for (let index = 0; index < estaciones_json.length; index++)
        {
          var element =  estaciones_json[index];
          if(element.state == x && element.activa)
          {
            contenido += '<option value="'+element.id+'">'+element.city+' - '+element.nombre+'</option>';
            numEstaciones ++;
          }
        }

        if(numEstaciones > 0)
        {
          $('#estaciones_select').html(contenido);
        }
        else
        {
          $('#estaciones_select').html('<option value="0">Sin estaciones</option>');
        }
      }

      function ponContaminantesSel()
      {
            var options = '<option value="0">3.-Selecciona Contaminate</option>'+
            '<option value="PM10_24" title="Las partículas menores o iguales a 2.5 micras (PM2.5) están formadas primordialmente por gases y por material proveniente de la combustión. Se depositan fundamentalmente en la región traqueobronquial (tráquea hasta bronquiolo terminal), aunque pueden ingresar a los alvéolos.">PM 10 µg/m&sup3;</option>'+
                '<option value="PM2.5_24" title="Las partículas menores o iguales a 2.5 micras (PM2.5) están formadas primordialmente por gases y por material proveniente de la combustión. Se depositan fundamentalmente en la región traqueobronquial (tráquea hasta bronquiolo terminal), aunque pueden ingresar a los alvéolos.">PM 2.5 µg/m&sup3;</option>'+
                '<option value="SO2_24" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.">SO2 (ppm) Promedio 24 horas</option>'+
                '<option value="SO2_8" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.">SO2 (ppm) Promedio 8 horas</option>'+
                '<option value="SO2_D" title="Gas incoloro que se forman al quemar azufre. La exposición a niveles altos de este contaminante produce irritación e inflamación de garganta y bronquios.">SO2 (ppm) Dato horario</option>'+
                '<option value="O3_8" title="Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.">Ozono (O3)(ppm) Promedio 8 horas</option>'+
                '<option value="O3_D" title="Es un compuesto gaseoso incoloro, que posee la capacidad de oxidar materiales, y causa irritación ocular y en las vías respiratorias.">Ozono (O3)(ppm) Dato horario</option>'+
                '<option value="NO2_24" title="El dióxido de nitrógeno es un compuesto químico gaseoso de color marrón amarillento, es un gas tóxico e irritante. La exposición a este gas disminuye la capacidad de difusión pulmonar.">NO2 (ppm)</option>'+
                '<option value="CO_24" title="Es un gas incoloro e inodoro que en concentraciones altas puede ser letal ya que forma carboxihemoglobina, la cual impide la oxígenación de la sangre.">CO (ppm)</option>';

          $('#contaminantes').html(options);
          $('#contaminantes').trigger( "change" );
      }

      function cambiaCoor()
      {
          var seleccionado = document.getElementById("estados").value;

          console.log(seleccionado);
          jQuery.each( coor_estado, function( i, val )
          {
            if(seleccionado == val.estado)
            {
                mymap.setView([val.lat, val.long], (val.zoom-1));
                console.log('entro');
            }
          });
      }

      function DateFalsa()
      {
        return new Date("2018-03-07 00:00:00");
      }

      function llenarConstaminantes(url, parametro)
      {
        $.ajax({
          type: 'GET',
          url: url,
          data: {},
          success: function( data, textStatus, jqxhr )
          {
            if(data.results.length > 0)
            {
              if('PM10' == parametro)
              {
                arrPM10 = data;
                $('#botonPM10').trigger('click');
                $('#myModal').modal('show');
                $('.forLoader').removeClass('hide').slideUp();
              }
              else if('PM2.5' == parametro)
              {
                arrPM2 = data;
              }
              else if('NO2' == parametro)
              {
                arrNO2 = data;
              }
              else if('CO' == parametro)
              {
                arrCO = data;
              }
              else if('O3' == parametro)
              {
                arrO3 = data;
              }
              else if('SO2' == parametro)
              {
                arrSO2 = data;
              }
            }
            else
            {

              $('#conataminatesMovil option').each(function(e)
                {
                  if($(this).val().includes(parametro))
                  {
                    $(this).attr('disabled','disabled');
                  }
                }
              );

              if('PM2.5' == parametro)
              {
                $('#botonPM25').addClass('bloqueado');
              }
              else if('PM10' == parametro)
              {
                $('#botonPM10').addClass('bloqueado');
                setTimeout(function()
                  {
                    buscarOtroParametro();
                  }, 5000);
              }
              else if('NO2' == parametro)
              {
                $('#botonNO2').addClass('bloqueado');
              }
              else if('CO' == parametro)
              {
                $('#botonCO').addClass('bloqueado');
              }
              else if('O3' == parametro)
              {
                $('#botonO38').addClass('bloqueado');
                $('#botonO3D').addClass('bloqueado');
              }
              else if('SO2' == parametro)
              {
                $('#botonSO2D').addClass('bloqueado');
                $('#botonSO28').addClass('bloqueado');
                $('#botonSO224').addClass('bloqueado');
              }
            }

          },
          error: function (xhr, ajaxOptions, thrownError)
          {
            alert(xhr.status);
            alert(thrownError);
          },
          xhrFields: {
            withCredentials: false
          },
          crossDomain: true,
          async:true
        });
      }

      function generaUrl(parametro,id_estacion,horas)
      {
        // cambiar estas horas con = new Date();
        // const dActual = DateFalsa();
        // var dPasada = DateFalsa();

        const dActual = new Date();
        var dPasada = new Date();

        dPasada.setHours(dActual.getHours() - horas);

        var url = 'https://api.datos.gob.mx/v2/sinaica?parametro='+parametro+'&estacionesid='+id_estacion+'&date-insert>'+getFormatDateAPI(dPasada)+'&date-insert<'+getFormatDateAPI(dActual)+'&pagesize='+1000;

        return url;
      }

      function buscarOtroParametro()
      {

        console.log("buscamos otro parametro");
        if(arrPM2.results.length > 0)
        {
          $('#botonPM25').trigger('click');
          $('#myModal').modal('show');
          $('.forLoader').removeClass('hide').slideUp();
        }
        else if(arrNO2.results.length > 0)
        {
          $('#botonNO2').trigger('click');
          $('#myModal').modal('show');
          $('.forLoader').removeClass('hide').slideUp();
        }
        else if(arrCO.results.length > 0)
        {
          $('#botonCO').trigger('click');
          $('#myModal').modal('show');
          $('.forLoader').removeClass('hide').slideUp();
        }
        else if(arrO3.results.length > 0)
        {
          $('#botonO38').trigger('click');
          $('#myModal').modal('show');
          $('.forLoader').removeClass('hide').slideUp();
        }
        else if(arrSO2.results.length > 0)
        {
          $('#botonSO224').trigger('click');
          $('#myModal').modal('show');
          $('.forLoader').removeClass('hide').slideUp();
        }
      }

      function cambioParametro(parametro, horas,id,titulo,lb)
      {
        if(!($('#'+id).hasClass('bloqueado')))
        {
          console.log(titulo);

          cambioBotonActivo(id);
          var estado =  $('#estado_primer_select').val();
          var estacion =  $('#estaciones_select').val();

          $('#contaminante_detalle').html(parametro);
          $('#contaminante_grafica').html(parametro);
          $('#tituloTexto').html(parametro);
          $('#textoTitulo').html(titulo);

          //porEstaciones(estado,estacion,parametro,horas);
          var promedioFinal = 0;
          var maximoL = 0;
          var label = "";
          if('PM10' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrPM10,horas,158);
            dataLocal = arrPM10;
            maximoL = 158;
            label = 'µg/m³';
          }
          else if('PM2.5' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrPM2,horas,158);
            dataLocal = arrPM2;
            maximoL = 158;
            label = 'µg/m³';
          }
          else if('NO2' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrNO2,horas, 0.315);
            dataLocal = arrNO2;
            maximoL = 0.315;
            label = 'ppm';
          }
          else if('CO' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrCO,horas,16.5);
            dataLocal = arrCO;
            maximoL = 16.5;
            label = 'ppm';
          }
          else if('O3' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrO3,horas,0.181);
            dataLocal = arrO3;
            maximoL = 0.181;
            label = 'ppm';
          }
          else if('SO2' == parametro)
          {
            promedioFinal = sacaDatoDiario(arrSO2,horas,0.32);
            dataLocal = arrSO2;
            maximoL = 0.32;
            label = 'ppm';
          }

          if(promedioFinal > 0)
          {
            putGrafica(parametro, horas, promedioFinal);
            $('.chart-gauge').html('');
            $('.chart-gauge').gaugeIt({selector:'.chart-gauge',value:promedioFinal.toFixed(2),label:label,gaugeMaxValue:maximoL});

          }
          else
          {
            alert("No es po sible obtener el valor solicitado para este día");
          }

        }

        //poner el promedio donde debe
        //llamar funcion del historico

      }

      function sacaDatoDiario(data,horas,max)
      {
        if(horas != 'D')
        {
          // const dActual = DateFalsa();
          // var dPasada = DateFalsa();

          const dActual = new Date();
          var dPasada = new Date();

          dPasada.setHours(dActual.getHours() - horas);

          var datos =  data.results;
          var arrTemp = [];
          for (let index = datos.length - 1; index >= 0;  index--)
          {

            var fechaValida = new Date(hacerFechaValida(datos[index]['date-insert']));

            console.log(fechaValida);
            console.log(fechaValida.getTime());

            if(fechaValida.getTime() >= dPasada.getTime() )
            {
              arrTemp.push(datos[index]);
            }
            else
            {
              break;
            }
          }

          var promedio = 0;
          var acumulado = 0;
          for (let index = 0; index < arrTemp.length; index++)
          {
            if(arrTemp[index].valororig < max && arrTemp[index].validoorig == 1)
            {
              acumulado += arrTemp[index].valororig;
              promedio++;
            }
          }

          if((arrTemp.length * .75) < promedio)
          {
            return acumulado/promedio;
          }
          else
          {
            return 0;
          }

        }
        else
        {
           return data.results[data.results.length-1].valororig;
        }
      }


    </script>
  </body>
</html>
